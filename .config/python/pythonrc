#!/usr/bin/env python3
import atexit
import os
import readline
import sys
from pathlib import Path


def is_vanilla() -> bool:
    """Return True for the standard CPython REPL on <3.13."""
    return (
        sys.version_info < (3, 13)
        and not hasattr(__builtins__, "__IPYTHON__")
        and "bpython" not in sys.argv[0]
    )


def history_path() -> Path:
    """Resolve the history file path using XDG state defaults."""
    env = os.environ.get("PYTHON_HISTORY") or os.environ.get("PYTHONHISTFILE")
    if env:
        path = Path(env).expanduser()
    else:
        # https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html#variables
        state_home = Path(os.environ.get("XDG_STATE_HOME", "~/.local/state")).expanduser()
        path = state_home / "python_history"

    if path.is_dir():
        path = path / "python_history"

    path.parent.mkdir(parents=True, exist_ok=True)
    return path


def read_history_text(path: Path) -> None:
    try:
        with path.open("r", encoding="utf-8") as f:
            for line in f:
                line = line.rstrip("\n")
                if not line or line.startswith("_HiStOrY_"):
                    continue
                readline.add_history(line)
    except FileNotFoundError:
        pass


def write_history_text(path: Path) -> None:
    length = readline.get_current_history_length()
    with path.open("w", encoding="utf-8") as f:
        for i in range(1, length + 1):
            item = readline.get_history_item(i)
            if item:
                f.write(item + "\n")


def setup_history() -> None:
    path = history_path()

    # https://github.com/python/cpython/issues/105694
    if not path.is_file():
        # Breaks on macOS python without creating the file first.
        readline.write_history_file(str(path))

    try:
        readline.read_history_file(str(path))
        atexit.register(readline.write_history_file, str(path))
    except (PermissionError, OSError):
        # libedit on macOS can fail with EPERM/EINVAL; fall back to plain text.
        read_history_text(path)
        atexit.register(write_history_text, path)


if is_vanilla():
    setup_history()
