[tools]
node = { version = "lts", postinstall = "corepack enable" }
python = "3.12"
rust = "stable"
go = "1.24"
perl = "5.42"

[settings]
experimental = true

# -------------------------
# Tasks :: update
# -------------------------

[tasks.update]
description = "Update all tools and global CLIs"
depends = [
  "update_brew",
  "update_zinit",
  "update_package_managers",
  "update_nvim",
]
run = [
  "pip install --upgrade tmuxp",
  "npm i -g @openai/codex",
  "echo Updates completed at $(date)",
]

[tasks.update_brew]
description = "Update Homebrew and all installed formulae/casks"
run = ["brew update", "brew upgrade"]

[tasks.update_zinit]
description = "Update zinit and plugins"
run = '''
#!/usr/bin/env zsh
# Source zinit explicitly so the function exists in this non-interactive shell
ZINIT_HOME="${ZINIT_HOME:-$HOME/.local/share/zinit}"
source "$ZINIT_HOME/zinit.git/zinit.zsh"

zinit self-update
zinit update --parallel --all
'''

[tasks.update_package_managers]
description = "Update package managers (pip, npm, etc.)"
run = ["pip install --upgrade pip", "npm i -g npm"]

[tasks.update_nvim]
description = "Update Neovim and plugins"
run = [
  "pip install --upgrade pynvim",
  "npm i -g neovim",
  "nvim --headless \"+Lazy! sync\" +qa",
]

# -------------------------
# Tasks :: clean
# -------------------------

[tasks.clean_env]
description = "Clean up old packages and caches"
depends = ["clean_brew", "clean_mise"]

[tasks.clean_brew]
description = "Cleanup Homebrew cache and old versions"
run = ["brew cleanup -s"]

[tasks.clean_mise]
description = "Mise prune"
run = ["mise prune"]

# [tasks.clean_zinit]
# description = "Clean zinit cache"
# run = '''
# #!/usr/bin/env zsh
# # Source zinit explicitly so the function exists in this non-interactive shell
# ZINIT_HOME="${ZINIT_HOME:-$HOME/.local/share/zinit}"
# source "$ZINIT_HOME/zinit.git/zinit.zsh"
#
# zinit delete --clean
# '''

# -------------------------
# Tasks :: setup
# -------------------------

[tasks.setup]
description = "Install/upgrade global CLIs by language/tool; then reshim"
depends = [
  "setup_node",
  "setup_python",
  "setup_lua",
  "setup_toml",
  "setup_sql",
  "setup_rust",
  "setup_go",
]
run = ["mise reshim"]

# Node (global CLIs)
[tasks.setup_node]
description = "Node globals via npm; enable Corepack for repo-declared managers"
run = ["corepack enable || true", "npm i -g npm", "npm i -g pyright prettier"]

# Python (global CLIs via pipx)
[tasks.setup_python]
description = "Python formatters/linters via pipx (uses mise python)"
run = [
  "pipx ensurepath || true",
  "pipx install --python $(which python3) ruff || pipx upgrade ruff",
  # "pipx install --python $(which python3) debugpy || pipx upgrade debugpy",
]

# Rebuild pipx shims after changing Python minor/patch
[tasks.python_rebuild]
description = "Reinstall pipx apps against current mise Python"
run = ["pipx reinstall-all --python $(mise which python)", "mise reshim"]

# Lua (via cargo)
[tasks.setup_lua]
description = "Lua tooling"
run = ["cargo install stylua || true"]

# TOML (via cargo)
[tasks.setup_toml]
description = "TOML tooling"
run = ["cargo install taplo-cli || true"]

# SQL (style/standards)
[tasks.setup_sql]
description = "SQL linting/formatting (configure dialects per-project; default postgres)"
run = [
  "pipx install --python $(which python3) sqlfluff || pipx upgrade sqlfluff",
]

# Rust (ensure analyzer available for rustaceanvim)
[tasks.setup_rust]
description = "Rust analyzer availability"
run = [
  "rustup default stable || true",
  "rustup component add rust-analyzer || true",
]

# Go (extras optional; LazyVim go extra covers basics)
[tasks.setup_go]
description = "Go tooling (optional extras)"
run = [
  # Examples to enable later:
  # "go install mvdan.cc/sh/v3/cmd/shfmt@latest",
  # "go install github.com/segmentio/golines@latest",
]
