# -------------------------
# Tasks :: update
# -------------------------

[tasks.update]
description = "Update all tools and global CLIs"
depends = [
  "update_brew",
  "update_zinit",
  "update_package_managers",
  "update_nvim",
  "update_pipx",
  "update_submodules",
  "update_gh",
]
run = [
  "bat cache --build",
  "pip install --upgrade tmuxp",
  "npm i -g @openai/codex",
  "echo Updates completed at $(date)",
]

[tasks.update_brew]
description = "Update Homebrew and all installed formulae/casks"
run = ["brew update", "brew upgrade"]

[tasks.update_zinit]
description = "Update zinit and plugins"
run = '''
#!/usr/bin/env zsh
# Source zinit explicitly so the function exists in this non-interactive shell
ZINIT_HOME="${ZINIT_HOME:-$HOME/.local/share/zinit}"
source "$ZINIT_HOME/zinit.git/zinit.zsh"

zinit self-update
zinit update --parallel --all
'''

[tasks.update_submodules]
description = "Update git submodules in dotfiles repo"
run = ["git -C $HOME/.dotfiles submodule update --remote"]

[tasks.update_package_managers]
description = "Update package managers (pip, npm, etc.)"
run = ["pip install --upgrade pip", "npm i -g npm"]

[tasks.update_nvim]
description = "Update Neovim and plugins"
run = [
  "pip install --upgrade pynvim",
  "npm i -g neovim",
  "nvim --headless \"+Lazy! sync\" +qa",
  "nvim --headless -c 'autocmd User MasonUpdateAllComplete quitall' -c 'MasonUpdateAll'",
]

[tasks.update_pipx]
description = "Update all pipx packages"
run = ["pipx upgrade-all"]

# Rebuild pipx shims after changing Python minor/patch
[tasks.python_rebuild]
description = "Reinstall pipx apps against current mise Python"
run = ["pipx reinstall-all --python $(mise which python)", "mise reshim"]

[tasks.update_gh]
description = "Update gh extensions"
run = ["gh extensions upgrade --all"]
