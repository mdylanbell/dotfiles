#!/usr/bin/env bash
set -euo pipefail

REPO_SSH="git@github.com:mdylanbell/dotfiles.git"
REPO_HTTPS="https://github.com/mdylanbell/dotfiles.git"
REPO_BRANCH="personal"
DOTDIR="${HOME}/.dotfiles"
DFM="${DOTDIR}/bin/dfm"

log() { printf "\033[1;32m==>\033[0m %s\n" "$*"; }
warn(){ printf "\033[1;33m!!\033[0m %s\n" "$*"; }
die() { printf "\033[1;31mXX\033[0m %s\n" "$*\n"; exit 1; }
is_cmd(){ command -v "$1" >/dev/null 2>&1; }

choose_remote() {
  if ssh -o BatchMode=yes -o ConnectTimeout=2 -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
    echo "$REPO_SSH"
  else
    echo "$REPO_HTTPS"
  fi
}

ensure_git_curl() {
  is_cmd git && is_cmd curl && return
  warn "Installing git/curl with system package manager…"
  case "$(uname -s)" in
    Darwin) die "Please run 'xcode-select --install' once, then re-run.";;
    Linux)
      if is_cmd apt-get; then sudo apt-get update && sudo apt-get install -y git curl ca-certificates
      elif is_cmd dnf; then sudo dnf install -y git curl ca-certificates
      elif is_cmd pacman; then sudo pacman -Sy --noconfirm git curl ca-certificates
      else die "No supported package manager for git/curl. Install manually."; fi
      ;;
    *) die "Unknown OS."; ;;
  esac
}

ensure_brew() {
  if is_cmd brew; then log "Homebrew: $(brew --prefix)"; return; fi
  log "Installing Homebrew/Linuxbrew…"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  if [[ "$(uname -s)" == "Darwin" ]]; then
    if [[ -x /opt/homebrew/bin/brew ]]; then eval "$(/opt/homebrew/bin/brew shellenv)"
    else eval "$(/usr/local/bin/brew shellenv)"; fi
  else
    if [[ -x "$HOME/.linuxbrew/bin/brew" ]]; then eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
    else eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"; fi
  fi
}

sync_dotfiles() {
  local remote; remote="$(choose_remote)"
  if [[ -d "$DOTDIR/.git" ]]; then
    log "Updating dotfiles in $DOTDIR"
    git -C "$DOTDIR" fetch --all --tags
    git -C "$DOTDIR" checkout "$REPO_BRANCH"
    git -C "$DOTDIR" pull --ff-only origin "$REPO_BRANCH"
  else
    log "Cloning dotfiles into $DOTDIR"
    git clone --branch "$REPO_BRANCH" "$remote" "$DOTDIR"
  fi
  log "Init submodules"
  git -C "$DOTDIR" submodule update --init --recursive

  [[ -x "$DFM" ]] || die "dfm not found at $DFM"
  log "dfm install"
  "$DFM" install
}

brew_bundle() {
  log "Brew bundle"
  if [[ -f "$DOTDIR/Brewfile" ]]; then
    brew update
    brew bundle --file="$DOTDIR/Brewfile"
  else
    warn "No Brewfile found at $DOTDIR/Brewfile (you said you want one—see template below)."
  fi
}

mise_setup() {
  # Ensure mise on PATH (installed via Brewfile)
  if ! is_cmd mise; then
    warn "mise not found; installing via brew"
    brew install mise
  fi

  # Trust your repo tasks and install runtimes/tools from config
  if [[ -f "$HOME/.config/mise/config.toml" ]]; then
    log "mise trust & install"
    mise trust "$HOME/.config/mise/config.toml" || true
  fi
  mise install
  mise reshim

  # Optional: run your setup task to install global tools
  if mise tasks | grep -qE '^\s*setup(\s|$)'; then
    log "mise run setup"
    mise run setup
  fi
}

zinit_setup() {
  # If your zsh config bootstraps zinit itself, you can skip this.
  if [[ -d "${HOME}/.local/share/zinit" || -d "${HOME}/.zinit" ]]; then
    log "zinit present"
  else
    log "Install zinit"
    bash -c "$(curl --fail --show-error --silent --location https://raw.githubusercontent.com/zdharma-continuum/zinit/HEAD/scripts/install.sh)"
  fi
}

post_checks() {
  log "Quick checks:"
  printf "  brew: %s\n" "$(brew --version | head -n1 || echo 'missing')"
  printf "  mise: %s\n" "$(mise --version || echo 'missing')"
  printf "  nvim: %s\n" "$(nvim --version | head -n1 || echo 'missing')"
}

main() {
  ensure_git_curl
  ensure_brew
  sync_dotfiles
  brew_bundle
  zinit_setup
  mise_setup
  post_checks
  log "Done. Open a new shell or run: exec $SHELL -l"
}

main "$@"
