#!/usr/bin/env bash
set -euo pipefail

REPO_SSH="git@github.com:mdylanbell/dotfiles.git"
REPO_HTTPS="https://github.com/mdylanbell/dotfiles.git"
REPO_BRANCH="main"
DOTDIR="${HOME}/.dotfiles"
DFM="${DOTDIR}/.local/bin/dfm"

log() { printf "\033[1;32m==>\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m!!\033[0m %s\n" "$*"; }
die() {
  printf "\033[1;31mXX\033[0m %s\n" "$*\n"
  exit 1
}
is_cmd() { command -v "$1" >/dev/null 2>&1; }

load_xdg_conf() {
  if [[ -f "$DOTDIR/.zshenv" ]]; then
    # shellcheck disable=SC1090
    source "$DOTDIR/.zshenv"
  fi

  local xdg_conf="$DOTDIR/.config/zsh/conf.d/50-xdg.zsh"
  if [[ -f "$xdg_conf" ]]; then
    # shellcheck disable=SC1090
    source "$xdg_conf"
  fi
}

choose_remote() {
  if ssh -o BatchMode=yes -o ConnectTimeout=2 -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
    echo "$REPO_SSH"
  else
    echo "$REPO_HTTPS"
  fi
}

ensure_linux_deps() {
  warn "Installing system packages (Linux only)…"
  case "$(uname -s)" in
    Darwin) die "Please run 'xcode-select --install' once, then re-run." ;;
    Linux)
      if is_cmd apt-get; then
        sudo apt-get update && sudo apt-get install -y \
          git \
          curl \
          ca-certificates \
          zsh \
          build-essential \
          libc6-dev \
          file
      elif is_cmd dnf; then
        sudo dnf install -y git curl ca-certificates
      elif is_cmd pacman; then
        sudo pacman -Sy --noconfirm git curl ca-certificates
      else die "No supported package manager for git/curl. Install manually."; fi
      ;;
    *) die "Unknown OS." ;;
  esac
}

ensure_brew() {
  if is_cmd brew; then
    log "Homebrew: $(brew --prefix)"
    return
  fi
  log "Installing Homebrew/Linuxbrew…"
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  if [[ "$(uname -s)" == "Darwin" ]]; then
    if [[ -x /opt/homebrew/bin/brew ]]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    else eval "$(/usr/local/bin/brew shellenv)"; fi
  else
    if [[ -x "$HOME/.linuxbrew/bin/brew" ]]; then
      eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
    else eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"; fi
  fi
}

sync_dotfiles() {
  if [[ -n "${DOTFILES_SKIP_GIT-}" ]]; then
    echo "dotfiles bootstrap: skipping git fetch/clone of dotfiles repository"
    return
  fi

  local remote
  remote="$(choose_remote)"
  if [[ -d "$DOTDIR/.git" ]]; then
    log "Updating dotfiles in $DOTDIR"
    git -C "$DOTDIR" fetch --all --tags
    git -C "$DOTDIR" checkout "$REPO_BRANCH"
    git -C "$DOTDIR" pull --ff-only origin "$REPO_BRANCH"
  else
    log "Cloning dotfiles into $DOTDIR"
    git clone --branch "$REPO_BRANCH" "$remote" "$DOTDIR"
  fi
  log "Init submodules"
  git -C "$DOTDIR" submodule update --init --recursive
}

run_dfm_install() {
  [[ -x "$DFM" ]] || die "dfm not found at $DFM"
  log "dfm install"
  "$DFM" install
}

brew_bundle() {
  log "Brew bundle"
  if [[ -f "$DOTDIR/Brewfile" ]]; then
    brew update
    brew bundle --file="$DOTDIR/Brewfile"
  else
    warn "No Brewfile found at $DOTDIR/Brewfile (you said you want one—see template below)."
  fi
}

mise_setup() {
  # Ensure mise on PATH (installed via Brewfile)
  if ! is_cmd mise; then
    warn "mise not found; installing via brew"
    brew install mise
  fi

  # Trust your repo tasks and install runtimes/tools from config
  if [[ -f "$HOME/.config/mise/config.toml" ]]; then
    log "mise trust & install"
    mise trust "$HOME/.config/mise/config.toml" || true
  fi
  mise install
  mise reshim

  # Optional: run your setup task to install global tools
  if mise tasks | grep -qE '^\s*setup(\s|$)'; then
    log "mise run setup"
    mise run setup
  fi
}

zinit_setup() {
  # If your zsh config bootstraps zinit itself, you can skip this.
  if [[ -d "${HOME}/.local/share/zinit" || -d "${HOME}/.zinit" ]]; then
    log "zinit present"
  else
    log "Install zinit"
    NO_EDIT=1 NO_TUTORIAL=1 \
      bash -c "$(curl --fail --show-error --silent --location https://raw.githubusercontent.com/zdharma-continuum/zinit/HEAD/scripts/install.sh)"
  fi
}

post_checks() {
  log "Quick checks:"
  printf "  brew: %s\n" "$(brew --version | head -n1 || echo 'missing')"
  printf "  mise: %s\n" "$(mise --version || echo 'missing')"
  printf "  nvim: %s\n" "$(nvim --version | head -n1 || echo 'missing')"
}

maybe_switch_shell() {
  local current_shell
  current_shell="$(ps -p "$$" -o comm= 2>/dev/null || true)"
  current_shell="${current_shell##*/}"
  if [[ "$current_shell" == "zsh" ]]; then
    return
  fi

  echo "zsh is not the current shell (detected: ${current_shell:-unknown})."
  printf "Switch default shell to zsh and start a login zsh now? [Y/n] "
  read -r reply
  case "${reply:-Y}" in
    Y | y | YES | Yes | yes)
      local zsh_path
      zsh_path="$(command -v zsh || true)"
      [[ -n "$zsh_path" ]] || die "zsh not found on PATH"
      local target_user
      target_user="${USER-$(id -un)}"
      sudo chsh -s "$zsh_path" "$target_user"
      exec "$zsh_path" -l
      ;;
    *) ;;
  esac
}

main() {
  load_xdg_conf
  ensure_linux_deps
  ensure_brew
  sync_dotfiles
  run_dfm_install
  brew_bundle
  zinit_setup
  mise_setup
  post_checks
  maybe_switch_shell
  log "Done. Open a new shell or run: exec $SHELL -l"
}

main "$@"
