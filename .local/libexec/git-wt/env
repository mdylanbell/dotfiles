#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"

usage() {
  cat <<'EOF'
Usage:
  git-wt env

Run inside a PR worktree. It:
  - diffs vs origin/main...HEAD
  - for each changed file, finds nearest parent containing pyproject.toml
  - runs: git-wt prepare + poetry install per component
EOF
}

[[ "${1:-}" =~ ^(-h|--help)$ ]] && {
  usage
  exit 0
}

command -v poetry >/dev/null 2>&1 || die "poetry not found"
command -v direnv >/dev/null 2>&1 || die "direnv not found (needed for prepare)"
# Ensure git-wt is on PATH; we invoke prepare via this tool.
command -v git-wt >/dev/null 2>&1 || die "git-wt not on PATH"

wt_git fetch origin main --quiet || true

repo_root="$(git rev-parse --show-toplevel)"
mapfile -t changed < <(git diff --name-only origin/main...HEAD)

if [[ ${#changed[@]} -eq 0 ]]; then
  echo "git-wt env: no changes vs origin/main...HEAD"
  exit 0
fi

git-wt prepare "$repo_root" || true

declare -A comps=()

find_component_root() {
  local rel="$1"
  local dir abs
  dir="$(dirname "$rel")"
  abs="$repo_root/$dir"

  while [[ "$abs" == "$repo_root"* ]]; do
    if [[ -f "$abs/pyproject.toml" ]]; then
      echo "$abs"
      return 0
    fi
    [[ "$abs" == "$repo_root" ]] && break
    abs="$(cd "$abs/.." && pwd)"
  done
  return 1
}

for f in "${changed[@]}"; do
  c="$(find_component_root "$f" || true)"
  [[ -n "${c:-}" ]] && comps["$c"]=1
done

if [[ ${#comps[@]} -eq 0 ]]; then
  echo "git-wt env: no pyproject.toml components detected from changed files." >&2
  exit 0
fi

for comp in "${!comps[@]}"; do
  echo "==> $comp"
  git-wt prepare "$comp" || true
  (cd "$comp" && poetry install)
done
