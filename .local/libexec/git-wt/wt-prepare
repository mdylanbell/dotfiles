#!/usr/bin/env bash
set -euo pipefail

TRUST_ROOT="${WT_TRUST_ROOT:-$HOME/code/work}"
target="${1:-$PWD}"
target="$(cd "$target" && pwd)"

if [[ "$target" != "$TRUST_ROOT"* ]]; then
  echo "git-wt prepare: refusing outside trust root: $TRUST_ROOT" >&2
  echo "Target: $target" >&2
  exit 1
fi

command -v direnv >/dev/null 2>&1 || exit 0
[[ -f "$target/.envrc" ]] || exit 0

(cd "$target" && direnv allow)
