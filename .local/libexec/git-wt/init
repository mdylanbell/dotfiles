#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"

wt_require_git

usage() {
  cat <<'EOF'
Usage:
  git-wt init [--protect-default=chain|false] <container_path> <remote_url>

Examples:
  git-wt init ~/code/work/repoA git@github.com:ORG/repoA.git
  git-wt init --protect-default=chain ~/code/work/repoA git@github.com:ORG/repoA.git
  git-wt init --protect-default=false ~/code/work/repoA git@github.com:ORG/repoA.git
EOF
}

protect_default=""
args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --protect-default)
      protect_default="$(wt_parse_protect_default_arg "${2:-}")"
      shift 2
      ;;
    --protect-default=*)
      protect_default="${1#*=}"
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      args+=("$1")
      shift
      ;;
  esac
done

container="${args[0]:-}"
remote="${args[1]:-}"

[[ -z "$container" || -z "$remote" || ${#args[@]} -gt 2 ]] && {
  usage
  exit 2
}

container="$(wt_abs_path "$container")"
mkdir -p "$container"

main="$container/main"
wt="$container/wt"

if [[ -d "$container/.git" || -f "$container/.git" ]]; then
  die "path is a git repository; use git-wt migrate instead: $container"
fi

if [[ -d "$main/.git" || -f "$main/.git" ]]; then
  die "container already initialized: $container"
fi

mkdir -p "$main" "$wt"
git clone "$remote" "$main"
wt_apply_protect_default "$main" "$protect_default"
echo "$container"
