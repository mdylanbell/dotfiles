#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"
wt_require_git

usage() {
  cat <<'EOF'
Usage:
  git-wt done [path] [--delete-branch] [--force]

Defaults:
  path = current directory

Notes:
  - Removes worktree first, then (optionally) deletes its branch.
EOF
}

target="${1:-$PWD}"
shift || true

delete_branch=false
force=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --delete-branch) delete_branch=true ;;
    --force) force=true ;;
    -h | --help)
      usage
      exit 0
      ;;
    *) die "Unknown flag: $1" ;;
  esac
  shift
done

target="$(cd "$target" && pwd)"

branch="$(git -C "$target" branch --show-current 2>/dev/null || true)"
default_branch="$(wt_default_branch)"
head_branch="$(git -C "$target" symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
pr_num=""
if [[ "$branch" =~ ^pr/([0-9]+)- ]]; then
  pr_num="${BASH_REMATCH[1]}"
fi

rm_flags=()
$force && rm_flags+=(--force)

wt_git worktree remove "${rm_flags[@]}" "$target"

if $delete_branch && [[ -n "$branch" ]]; then
  protected=false
  case "$branch" in
    "$default_branch" | "$head_branch" | main | master | trunk) protected=true ;;
  esac

  if ! $protected && wt_git show-ref --verify --quiet "refs/heads/$branch"; then
    wt_git branch -D "$branch"
  fi
fi

if [[ -n "$pr_num" ]]; then
  still_used=false
  while IFS= read -r line; do
    case "$line" in
      branch\ refs/heads/pr/"$pr_num"-*)
        still_used=true
        break
        ;;
    esac
  done < <(wt_git worktree list --porcelain)

  if ! $still_used; then
    wt_git remote remove "pr-$pr_num" >/dev/null 2>&1 || true
  fi
fi
