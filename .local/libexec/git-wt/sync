#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"
wt_require_git

usage() {
  cat <<'EOF'
Usage:
  git-wt sync [--container <path>] [--prune]

Fetch origin and fast-forward main to origin/<default>.

Options:
  --prune   Prune stale remote-tracking refs after fetch
EOF
}

prune=false
container=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --container)
      container="$(wt_abs_path "$(wt_parse_container_arg "${2:-}")")"
      shift 2
      ;;
    --prune)
      prune=true
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      die "unknown flag: $1"
      ;;
  esac
done

container="$(wt_resolve_container "${container:-$PWD}")"
main_dir="$(wt_main_for "$container")"
git_main() { git -C "$main_dir" "$@"; }

default_branch="$(wt_default_branch_for "$container")"
fetch_args=()
$prune && fetch_args+=(--prune)

git_main fetch origin "${fetch_args[@]}" "$default_branch"

if git_main status --porcelain | grep -q .; then
  die "main worktree is dirty; refusing to fast-forward"
fi

git_main checkout "$default_branch" || die "git checkout $default_branch failed"
git_main merge --ff-only "origin/$default_branch"

echo "$main_dir"
