#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"
wt_require_git

usage() {
  cat <<'EOF'
Usage:
  git-wt new [--base <branch>] <branch-name>

Creates worktree under:
  <container>/wt/<branch>

Prints resulting path.
EOF
}

base=""
branch=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --base)
      base="${2:-}"
      [[ -n "$base" ]] || die "--base requires a branch name"
      shift 2
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      branch="${1:-}"
      shift
      ;;
  esac
done

[[ -z "$branch" ]] && {
  usage
  exit 2
}

wt_dir="$(wt_wt)"
mkdir -p "$wt_dir"

default_branch="$(wt_default_branch)"
base="${base:-$default_branch}"
base_ref="$base"
if [[ "$base_ref" != origin/* ]]; then
  base_ref="origin/$base_ref"
fi

fetch_branch="${base_ref#origin/}"
wt_git fetch origin "$fetch_branch" --quiet || die "failed to fetch origin/$fetch_branch"

if wt_git show-ref --verify --quiet "refs/heads/$branch"; then
  die "branch already exists: $branch"
fi

dest="$wt_dir/$(wt_slugify "$branch")"
if [[ -e "$dest" ]]; then
  die "destination already exists: $dest"
fi

wt_git worktree add -b "$branch" "$dest" "$base_ref"

echo "$dest"
