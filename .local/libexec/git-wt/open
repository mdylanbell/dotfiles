#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"
wt_require_git

usage() {
  cat <<'EOF'
Usage:
  git-wt open [--container <path>] <branch>

Open a worktree using the configured command.
EOF
}

container=""
branch=""
dry_run=false
verbose=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --container)
      container="$(wt_abs_path "$(wt_parse_container_arg "${2:-}")")"
      shift 2
      ;;
    --dry-run)
      dry_run=true
      shift
      ;;
    --verbose)
      verbose=true
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      if [[ -z "$branch" ]]; then
        branch="$1"
        shift
        continue
      fi
      die "unknown flag: $1"
      ;;
  esac
done

[[ -n "$branch" ]] || { usage; exit 2; }

container="$(wt_resolve_container "${container:-$PWD}")"
wt_path="$(wt_worktree_path_for_branch "$container" "$branch")"
if [[ -f "$(wt_config_path "$container")" ]] && ! command -v python3 >/dev/null 2>&1; then
  die "python3 required to read git-wt.toml"
fi
cmd="$(wt_config_get_string "$container" open cmd)"

if [[ -z "$cmd" ]]; then
  die "open.cmd is not set; configure with: git-wt config set open.cmd \"<command>\""
fi

if $dry_run; then
  echo "would run: (cd \"$wt_path\" && $cmd)"
  exit 0
fi

if $verbose; then
  echo "worktree: $wt_path"
  echo "running: (cd \"$wt_path\" && $cmd)"
fi

(cd "$wt_path" && eval "$cmd")
